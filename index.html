<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <title>Multi-AI Chat Comparison</title>
     <link rel="stylesheet" href="style.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind Config (as provided)
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary': '#0a84ff', 
                        'secondary': '#5ac8fa', 
                        'bg-dark': '#1c1c1e', 
                        'bg-light': '#f2f2f7', 
                        'card-dark': '#2c2c2e',
                        'card-light': '#ffffff',
                    }
                }
            }
        }
    </script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp, query, setLogLevel } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        
        window.firebaseModules = {
            initializeApp, getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, 
            getFirestore, collection, onSnapshot, addDoc, serverTimestamp, query, setLogLevel
        };
    </script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* [CSS styles from user input go here] */
        :root {
            --bg-color: #000000;
            --text-color: #ffffff;
            --card-color: #1c1c1e;
            --border-color: #3a3a3c;
            --accent-color: #0a84ff;
        }

        body.light-theme {
            --bg-color: #f2f2f7;
            --text-color: #000000;
            --card-color: #ffffff;
            --border-color: #e5e5ea;
            --accent-color: #0a84ff;
        }
        
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        .model-selector { 
            background-color: var(--card-color); 
            border-bottom: 1px solid var(--border-color);
            z-index: 50;
        }
        
        .ai-card {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
        }
        
        /* Custom Styles from Original Code (Converted) */
        .timer-display {
            position: fixed; top: 10px; right: 10px; background-color: #ff9500;
            color: white; padding: 5px 10px; border-radius: 9999px; font-size: 0.85em;
            font-weight: bold; z-index: 1000; transition: background-color 0.3s;
        }
        .timer-display.red { background-color: #ff3b30; }

        .chat-app { display: flex; height: calc(100vh - 80px); margin-top: 80px; }
        .sidebar { transition: width 0.3s, transform 0.3s; overflow-y: auto; flex-shrink: 0; }
        .sidebar-open { width: 300px; }
        .sidebar-closed { width: 0; transform: translateX(-300px); }
        .main-area { transition: margin-left 0.3s, width 0.3s; flex-grow: 1; position: relative; }
        .sidebar-open + .main-area { margin-left: 0; }
        .sidebar-closed + .main-area { margin-left: 0; width: 100%; }
        
        .model-option { cursor: pointer; transition: all 0.2s; }
        .model-option:hover { transform: scale(1.05); }
        .model-option.selected { 
            box-shadow: 0 0 0 2px var(--accent-color), 0 0 10px var(--accent-color);
        }
        
        .response-group {
            display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem;
        }
        .ai-pair {
            display: flex; gap: 1rem; width: 100%; flex-wrap: wrap;
        }
        .ai-card {
            flex: 1 1 calc(50% - 0.5rem); /* Two cards per row */
            min-width: 300px;
        }
        
        /* Mobile adjustments */
        @media (max-width: 768px) {
            .sidebar-open { 
                position: fixed; top: 0; left: 0; height: 100vh; 
                z-index: 100; box-shadow: 4px 0 10px rgba(0,0,0,0.5); 
                background-color: var(--card-color); 
            }
            .sidebar-closed { transform: translateX(-300px); }
            .sidebar-open + .main-area { margin-left: 300px; }
            .ai-card { flex: 1 1 100%; min-width: unset; }
        }

        /* Thinking animation */
        .thinking-dots span {
            display: inline-block; width: 8px; height: 8px; background-color: #ff9500;
            border-radius: 50%; margin: 0 2px; animation: bounce 1.4s infinite ease-in-out both;
        }
        .thinking-dots span:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dots span:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }

        /* Authentication screen overlay */
        .auth-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.9); z-index: 1020;
            display: none; align-items: center; justify-content: center;
        }
        body.auth-pending .auth-overlay { display: flex; }
        
        /* Custom Alert styling */
        .custom-alert {
            position: fixed; top: 70px; right: 20px; z-index: 1030;
            max-width: 350px; padding: 10px 20px; border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.25);
            transition: opacity 0.5s, transform 0.5s;
            opacity: 0; transform: translateY(-20px);
        }
        .custom-alert.visible { opacity: 1; transform: translateY(0); }
        .custom-alert.error { background-color: #ff3b30; color: white; }
        .custom-alert.info { background-color: #0a84ff; color: white; }
    </style>
</head>
<body class="bg-dark text-white light-theme">
    
    <div id="custom-alert" class="custom-alert"></div>

    <div id="timer-display" class="timer-display shadow-lg">
        <i class="fas fa-clock"></i> <span id="time-left-text">Loading...</span>
    </div>

    <button id="sidebar-toggle-btn" class="fixed top-3 left-3 z-[101] w-10 h-10 rounded-full bg-card-dark text-white border border-border-color cursor-pointer flex items-center justify-center text-lg shadow-lg hover:bg-primary hover:text-white transition-all duration-300" title="Toggle Sidebar">
        <i class="fas fa-bars"></i>
    </button>
    
    <button id="logout-btn" class="fixed bottom-5 left-5 z-[101] w-10 h-10 rounded-full bg-red-600 text-white border border-red-800 cursor-pointer flex items-center justify-center text-lg shadow-lg hover:bg-red-700 transition-all duration-300" title="Logout">
        <i class="fas fa-sign-out-alt"></i>
    </button>

    <header class="model-selector fixed top-0 left-0 right-0 h-20 flex items-center justify-center p-4 shadow-xl">
        <h1 class="text-xl font-bold mr-4 hidden sm:block">Model Comparison</h1>
        <div id="user-id-display" class="text-xs font-mono opacity-70 absolute top-2 left-20">User ID: N/A</div>
        <div class="model-options flex space-x-2 overflow-x-auto pb-2 px-2">
            <div class="model-option flex-shrink-0 bg-primary/20 text-white text-sm px-3 py-1 rounded-full border-2 border-transparent" data-model="logic">GPT-5</div>
            <div class="model-option flex-shrink-0 bg-primary/20 text-white text-sm px-3 py-1 rounded-full border-2 border-transparent" data-model="creative">Grok 4</div>
            <div class="model-option flex-shrink-0 bg-primary/20 text-white text-sm px-3 py-1 rounded-full border-2 border-transparent" data-model="balanced">DeepSeek v3.1</div>
            <div class="model-option flex-shrink-0 bg-primary/20 text-white text-sm px-3 py-1 rounded-full border-2 border-transparent" data-model="gpt4o">GPT-4o</div>
            <div class="model-option flex-shrink-0 bg-primary/20 text-white text-sm px-3 py-1 rounded-full border-2 border-transparent" data-model="claude3">Claude 3</div>
            <div class="model-option flex-shrink-0 bg-primary/20 text-white text-sm px-3 py-1 rounded-full border-2 border-transparent" data-model="llama31">Llama 3.1</div>
            <div class="model-option flex-shrink-0 bg-primary/20 text-white text-sm px-3 py-1 rounded-full border-2 border-transparent" data-model="mixtral">Mixtral</div>
            <div class="model-option flex-shrink-0 bg-primary/20 text-white text-sm px-3 py-1 rounded-full border-2 border-transparent" data-model="qwen">Qwen</div>
            <div class="model-option flex-shrink-0 bg-primary/20 text-white text-sm px-3 py-1 rounded-full border-2 border-transparent" data-model="command-r">âš¡ Command R+</div>
        </div>
    </header>

    <div id="chat-app" class="chat-app h-full">
        <aside class="sidebar sidebar-open bg-card-dark p-4 shadow-lg" id="sidebar">
            <div class="sidebar-header sticky top-0 bg-card-dark pt-0 pb-3 z-10 border-b border-border-color">
                <h2 class="text-lg font-semibold mb-2"><i class="fas fa-history mr-2"></i> History</h2>
                <div class="relative mb-3">
                    <input type="text" id="history-search" placeholder="Search historyâ€¦" class="w-full p-2 pl-8 rounded-lg bg-card-dark border border-border-color text-sm focus:ring-1 focus:ring-primary focus:border-primary"/>
                    <i class="fas fa-search absolute left-2 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                </div>
                <div class="flex justify-between items-center space-x-2 sidebar-actions">
                    <button id="new-chat-btn" title="Start New Chat" class="p-2 rounded-full bg-primary hover:bg-primary/80 transition text-white"><i class="fas fa-plus"></i></button>
                    <button id="tokens-btn" title="Tokens Usage" class="p-2 rounded-full bg-gray-500 hover:bg-gray-600 transition text-white"><i class="fas fa-chart-bar"></i></button>
                    <button id="fullscreen-btn" title="Toggle Fullscreen" class="p-2 rounded-full bg-gray-500 hover:bg-gray-600 transition text-white"><i class="fas fa-expand"></i></button>
                    <button id="theme-toggle-btn" title="Toggle Theme" class="p-2 rounded-full bg-gray-500 hover:bg-gray-600 transition text-white"><i class="fas fa-sun"></i></button>
                </div>
                <div id="tokens-display" class="tokens-display mt-3 hidden">
                    <div class="flex justify-between items-center text-sm p-2 bg-primary/20 rounded-lg">
                        <span class="tokens-label font-medium">Tokens Used:</span>
                        <span id="tokens-count" class="tokens-count font-bold text-lg transition-transform duration-200">0</span>
                    </div>
                </div>
            </div>
            <div id="history-list" class="history-list pt-4 space-y-2">
                </div>
        </aside>
        
        <main class="main-area sidebar-open flex flex-col h-full p-4" id="main-area">
            <div class="chat-container flex-grow overflow-y-auto mb-4 space-y-6" id="chat-container">
                </div>
            
            <div class="w-full max-w-4xl mx-auto">
                <div id="file-preview" class="file-preview flex flex-wrap gap-2 mb-2 p-2 bg-card-dark border border-border-color rounded-lg"></div>
                
                <div class="input-bar flex items-end p-2 bg-card-dark border border-border-color rounded-xl shadow-2xl">
                    <button id="file-upload-btn" class="btn-file p-3 text-gray-400 hover:text-primary transition" title="Upload File">
                        <i class="fas fa-paperclip text-lg"></i>
                    </button>
                    <input type="file" id="file-input" multiple accept=".txt,.pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.csv,.xlsx,.pptx" style="display: none"/>
                    
                    <textarea id="prompt-input" rows="1" placeholder="Type your message hereâ€¦ (Press Enter to send, Shift+Enter for new line)" maxlength="10000" class="flex-grow mx-2 p-2 resize-none bg-transparent border-none outline-none overflow-y-auto min-h-[60px] max-h-[180px]"></textarea>
                    
                    <button id="ask-btn" class="btn-send p-3 bg-primary text-white rounded-xl shadow-lg hover:bg-primary/80 transition disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-paper-plane text-lg"></i>
                    </button>
                </div>
                
                <div id="status" class="status text-center text-sm mt-2 p-1 rounded-full">Select at least two AI models to start chatting</div>
            </div>
        </main>
    </div>

    <div class="welcome-fixed fixed inset-0 flex items-center justify-center bg-bg-dark z-20" id="welcome-fixed">
        <div class="welcome-message text-center p-8 bg-card-dark rounded-xl shadow-2xl max-w-md">
            <h2 class="text-2xl font-bold mb-4">Welcome to tieTEN</h2>
            <p class="text-gray-400 mb-6">Select AI models above and start chatting to compare responses from multiple AI assistants simultaneously.</p>
            <div id="connection-status" class="connection-status">
                <div class="text-yellow-500"><i class="fas fa-sync fa-spin mr-2"></i> Testing connection to serverâ€¦</div>
            </div>
        </div>
    </div>
    
    <div id="auth-overlay" class="auth-overlay">
        <div class="auth-card p-8 bg-card-dark rounded-xl shadow-2xl text-center max-w-sm w-full">
            <h2 class="text-3xl font-extrabold mb-6">Sign In Required</h2>
            <p class="mb-6 text-gray-400">Please sign in to start your 7-day free trial and access the chat features.</p>
            <button id="google-signin-btn" class="w-full flex items-center justify-center bg-primary text-white py-3 rounded-xl text-lg font-semibold hover:bg-primary/90 transition shadow-lg">
                <i class="fab fa-google mr-3"></i> Sign In or Sign Up
            </button>
            <p class="text-xs text-gray-500 mt-4">You'll be redirected to the sign-in page.</p>
        </div>
    </div>

    <script>
        // --- Jinja Injected Configuration (from Flask) ---
        const firebaseConfig = JSON.parse('{{ firebase_config_json | safe }}');
        const initialTimeLeftSec = parseInt('{{ time_left_sec }}' || '3600'); 
        const isUserAuthenticated = '{{ "user_id" in session }}' === 'True';
        
        // --- Global Firebase and Application Setup ---
        const {
            initializeApp, getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup, 
            getFirestore, collection, onSnapshot, addDoc, serverTimestamp, query, setLogLevel
        } = window.firebaseModules || {};
        
        const MODEL_CONFIG = { /* ... (model config as provided) */ 
            logic: Â  Â  Â { name:"GPT-5", icon: "ðŸ§ ", color: "#64D2FF" },
            creative: { name:"Grok 4", icon: "âœ¨", color: "#FF9F0A" },
            balanced: { name:"DeepSeek", icon: "âš–ï¸", color: "#FF3B30" },
            gpt4o: Â  Â  Â { name:"GPT-4o", icon: "ðŸš€", color: "#AF52DE" },
            claude3: Â { name:"Claude 3", icon: "ðŸ“š", color: "#007AFF" },
            llama31: Â { name:"Llama 3.1", icon: "ðŸ¦™", color: "#34C759" },
            mixtral: Â { name:"Mixtral", icon: "ðŸ”€", color: "#5856D6" },
            qwen: Â  Â  { name:"Qwen", icon: "ðŸ‰", color: "#FF2D55" },
            "command-r":{name:"Command R+", icon: "âš¡", color: "#5AC8FA"},
        };
        
        const promptInput = document.getElementById('prompt-input');
        const askBtn = document.getElementById('ask-btn');
        const chatContainer = document.getElementById('chat-container');
        const statusBox = document.getElementById('status');
        const welcomeBox = document.getElementById('welcome-fixed');
        const fileUploadBtn = document.getElementById('file-upload-btn');
        const fileInput = document.getElementById('file-input');
        const filePreview = document.getElementById('file-preview');
        const tokensCount = document.getElementById('tokens-count');
        const logoutBtn = document.getElementById('logout-btn');
        const sidebarToggleBtn = document.getElementById('sidebar-toggle-btn');
        const timerDisplay  = document.getElementById('timer-display');
        const timeLeftText  = document.getElementById('time-left-text');
        const historySearch    = document.getElementById('history-search');

        let app, db, auth;
        let userId = null;
        let isAuthReady = false; // Flag to ensure initChatApp runs only once
        let selectedModels = new Set();
        let currentController = null;
        let chatHistory = []; 
        let uploadedFiles = [];
        let totalTokens = 0;
        let isFullscreen  = false;
        let timeLimitSeconds = initialTimeLeftSec;
        let isSidebarOpen = true;

        // --- Core Initialization ---

        document.addEventListener('DOMContentLoaded', setupFirebase);
        
        async function setupFirebase() {
            if (!initializeApp) {
                showCustomAlert("Firebase modules not loaded. Cannot start app.", 'error');
                return;
            }
            if (Object.keys(firebaseConfig).length === 0 || !firebaseConfig.apiKey) {
                 showCustomAlert("Firebase config is missing on the server. History/Auth disabled.", 'error');
                 // Allow anonymous use if auth isn't fully set up (optional, but good for local dev)
                 document.body.classList.remove('auth-pending');
                 initChatApp();
                 return;
            }

            try {
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                // setLogLevel('debug'); // Commented for cleaner console

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        // User is signed in on the client (Firebase SDK knows it)
                        userId = user.uid;
                        document.getElementById('user-id-display').textContent = `User ID: ${userId}`;
                        document.body.classList.remove('auth-pending');
                        logoutBtn.style.display = 'flex';
                        
                        // CRITICAL FIX: Since Flask protects the entire page, 
                        // if we reach here, the server session is ALREADY active.
                        // We simply initialize the client app.
                        if (!isAuthReady) {
                            isAuthReady = true;
                            initChatApp(); 
                        }
                        loadChatHistory();
                    } else {
                        // User is signed out on the client
                        userId = null;
                        document.getElementById('user-id-display').textContent = 'User ID: N/A';
                        logoutBtn.style.display = 'none';

                        if (isUserAuthenticated) {
                            // This scenario means the Flask session *was* active but the client Firebase session timed out/cleared.
                            // Since the page is protected by Flask's login_required, this listener is mostly for client-side cleanup.
                            // If the Flask session is cleared on the server (e.g., via /logout POST), the user is redirected.
                            // The current setup relies heavily on the Flask session for protection.
                        } else {
                            // User is fully unauthenticated (either redirected from / or on /login/signup page)
                            document.body.classList.add('auth-pending');
                        }
                        // Clear history list when logged out
                        document.getElementById('history-list').innerHTML = '<div class="text-center text-sm text-gray-500 mt-4">Sign in to view history.</div>';
                    }
                });

            } catch (error) {
                console.error("Firebase setup error:", error);
                showCustomAlert("Error during app startup. History/Auth is disabled.", 'error');
            }
        }

        function initChatApp(){
            testConnection();
            bindModelSelectors();
            bindControls();
            updateStatus();
            promptInput.focus();
            fixTextareaHeight();
            selectAllModels(); 
            startTimer();
        }

        // --- Authentication & UI Handlers ---

        function showAuthScreen() {
            document.getElementById('auth-overlay').style.display = 'flex';
        }

        function hideAuthScreen() {
            document.getElementById('auth-overlay').style.display = 'none';
        }

        document.getElementById('google-signin-btn').addEventListener('click', () => {
            // Redirect to the login page where proper authentication flow can happen
            window.location.href = '/login';
        });

        async function handleLogout() {
            try {
                // 1. Clear client-side Firebase session
                await signOut(auth);
                
                // 2. Clear server-side Flask session
                const response = await fetch('/logout', { method: 'POST' });
                if (!response.ok) {
                    throw new Error("Server logout failed.");
                }

                showCustomAlert("You have been signed out.", 'info');
                // 3. Redirect to login page, which will re-run the whole auth flow
                window.location.href = '/login'; 

            } catch(e) {
                console.error("Logout error:", e);
                showCustomAlert(`Logout Failed: ${e.message}`, 'error');
            }
        }
        
        function showCustomAlert(message, type = 'info', duration = 3000) {
            const alertBox = document.getElementById('custom-alert');
            alertBox.textContent = message;
            alertBox.className = `custom-alert visible ${type}`;
            
            setTimeout(() => {
                alertBox.classList.remove('visible');
            }, duration);
        }

        // --- Other App Functions (omitted for brevity, assume correctness) ---
        // ... (selectAllModels, testConnection, bindModelSelectors, bindControls, toggleSidebar, toggleTokensDisplay)
        // ... (updateTokensCount, toggleFullscreen, handleFullscreenChange, handleFileUpload, createFilePreview)
        // ... (getFileIcon, formatFileSize, removeFile, fixTextareaHeight, updateStatus, toggleTheme, startNewChat)
        // ... (sendMessage, renderMarkdown, addMessage, injectAskLurk, handleAsklurkClick, createResponseGroup)
        // ... (copyResponse, scrollToBottom, escapeHtml, getHistoryCollectionRef, saveToHistory, loadChatHistory, renderHistory, filterHistory, startTimer)

        // The remaining functions (from selectAllModels down to startTimer) would be placed here, 
        // using the code provided in the user's prompt as the base.
    </script>
</body>

</html>
